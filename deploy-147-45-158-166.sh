#!/bin/bash

###############################################################################
# –î–ï–ü–õ–û–ô –§–ò–ù–ê–õ–¨–ù–û–ì–û –î–ò–ó–ê–ô–ù–ê –ë–ï–ó –≠–ú–û–î–ó–ò
# –°–µ—Ä–≤–µ—Ä: 147.45.158.166
# –ü—Ä–æ–µ–∫—Ç: /var/www/kamchatour
###############################################################################

set -e

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${GREEN}‚úì${NC} $1"; }
log_warn() { echo -e "${YELLOW}‚ö†${NC} $1"; }
log_error() { echo -e "${RED}‚úó${NC} $1"; }
log_step() { echo -e "${BLUE}‚ñ∂${NC} $1"; }

echo "üé® –î–ï–ü–õ–û–ô –§–ò–ù–ê–õ–¨–ù–û–ì–û –î–ò–ó–ê–ô–ù–ê –ë–ï–ó –≠–ú–û–î–ó–ò"
echo "========================================"
echo "–°–µ—Ä–≤–µ—Ä: 147.45.158.166"
echo "–ü—Ä–æ–µ–∫—Ç: /var/www/kamchatour"
echo ""

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
log_step "–ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞..."
cd /var/www/kamchatour || {
    log_error "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /var/www/kamchatour –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    exit 1
}
log_info "–í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: $(pwd)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ git
log_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π –≤–µ—Ç–∫–∏..."
CURRENT_BRANCH=$(git branch --show-current)
log_info "–¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
log_step "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub..."
git fetch origin main
git reset --hard origin/main
log_info "–ö–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞
LAST_COMMIT=$(git log -1 --oneline)
log_info "–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç: $LAST_COMMIT"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
log_step "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install
log_info "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
log_step "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 delete kamchatour 2>/dev/null || log_warn "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –±—ã–ª–æ –∑–∞–ø—É—â–µ–Ω–æ"

# –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
log_step "–û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ —Å–±–æ—Ä–∫–∏..."
rm -rf .next
rm -rf node_modules/.cache
log_info "–ö–µ—à –æ—á–∏—â–µ–Ω"

# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
log_step "–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 2-3 –º–∏–Ω—É—Ç—ã)..."
npm run build
log_info "–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
log_step "–ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 start npm --name kamchatour -- start
log_info "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ"

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PM2
log_step "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PM2..."
pm2 save
log_info "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
log_step "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
sleep 3
pm2 status kamchatour

# –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
echo ""
echo "========================================"
echo -e "${GREEN}‚úÖ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–Å–ù –£–°–ü–ï–®–ù–û!${NC}"
echo "========================================"
echo ""
echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
echo "  –°–µ—Ä–≤–µ—Ä:     http://147.45.158.166/"
echo "  –ü—Ä–æ–µ–∫—Ç:     /var/www/kamchatour"
echo "  –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: kamchatour"
echo ""
echo "üîç –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  pm2 logs kamchatour       - –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
echo "  pm2 restart kamchatour    - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫"
echo "  pm2 status                - —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π"
echo "  curl -I http://147.45.158.166/  - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏"
echo ""
echo "üé® –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–∏–∑–∞–π–Ω–µ:"
echo "  ‚úÖ –£–¥–∞–ª–µ–Ω—ã –í–°–ï —ç–º–æ–¥–∑–∏ (100+ –º–µ—Å—Ç)"
echo "  ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã lucide-react –∏–∫–æ–Ω–∫–∏"
echo "  ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω WeatherBackground"
echo "  ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω—ã CSS —Ç–µ–º—ã Samsung Weather"
echo "  ‚úÖ –ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–π —Å–≤–µ—Ç–ª—ã–π –¥–∏–∑–∞–π–Ω"
echo ""

# –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤
log_step "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
pm2 logs kamchatour --lines 20 --nostream

echo ""
log_info "–ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: http://147.45.158.166/"
