# Отчет по проблемам регистрации партнеров

## Критические проблемы найдены:

### 1. **Архитектурная проблема: несвязанные таблицы `users` и `partners`**
- ❌ Таблица `partners` НЕ имеет поля `user_id` для связи с таблицей `users`
- ❌ При регистрации партнера создается только запись в `partners`, НО НЕ создается пользователь
- ❌ Партнер не может войти в систему, так как авторизация работает через таблицу `users`

### 2. **Отсутствует поле `password_hash` в таблице `users`**
- ❌ В `/workspace/lib/database/schema.sql` таблица `users` НЕ имеет поля `password_hash`
- ✅ В `/workspace/scripts/init-postgresql.sql` это поле ЕСТЬ
- ❌ Несоответствие схем приводит к ошибкам

### 3. **API `/api/partners/register/route.ts` имеет множество проблем:**
- ❌ Строка 7: импортирует `query` из `@/lib/database` (правильно)
- ❌ Строки 44-47: пароль НЕ хешируется (есть TODO комментарий)
- ❌ Строка 47: пароль сохраняется в переменную `passwordHash`, но НЕ используется
- ❌ Строки 75-121: создается только партнер, НО НЕ создается пользователь
- ❌ Строка 51: проверка email через JSONB `contact->>'email'` неэффективна
- ❌ НЕТ создания JWT токена для автоматической авторизации
- ❌ НЕТ создания сессии пользователя

### 4. **Проблемы с бизнес-логикой:**
- ❌ Партнер может выбрать несколько ролей, но для каждой создается ОТДЕЛЬНАЯ запись в `partners`
- ❌ Это создает путаницу: один партнер = несколько ID
- ❌ После регистрации партнер перенаправляется на `/partner/dashboard`, но не может туда зайти

### 5. **Отсутствуют необходимые зависимости:**
- ❌ Не установлен `bcryptjs` для хеширования паролей (нет в package.json)
- ❌ Не импортируется bcrypt в API роуте

## Решение:

### Шаг 1: Добавить миграции
1. Миграция 006: Добавить `password_hash` в таблицу `users`
2. Миграция 007: Добавить `user_id` в таблицу `partners`

### Шаг 2: Установить зависимости
```bash
npm install bcryptjs
npm install --save-dev @types/bcryptjs
```

### Шаг 3: Переписать `/api/partners/register`
- Хешировать пароль с bcrypt
- Создать пользователя в таблице `users` с ролью из массива roles
- Создать партнера в таблице `partners` со ссылкой на user_id
- Создать JWT токен и сессию
- Вернуть токен для автоматической авторизации

### Шаг 4: Исправить бизнес-логику
- Один партнер = одна запись в `partners`
- Использовать JSONB массив для хранения multiple roles
- Или создать таблицу `partner_roles` для связи many-to-many

## Статус:
- [x] Анализ завершен
- [ ] Миграции созданы
- [ ] Зависимости установлены
- [ ] API переписан
- [ ] Тестирование выполнено
